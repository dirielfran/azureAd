<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arquitectura del Sistema - Angular + Spring Boot + Azure AD</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 40px;
            color: #333;
            background-color: #ffffff;
        }
        
        h1 {
            color: #1976d2;
            border-bottom: 3px solid #1976d2;
            padding-bottom: 10px;
            font-size: 28px;
        }
        
        h2 {
            color: #7b1fa2;
            border-left: 4px solid #7b1fa2;
            padding-left: 15px;
            margin-top: 30px;
            font-size: 22px;
        }
        
        h3 {
            color: #388e3c;
            margin-top: 25px;
            font-size: 18px;
        }
        
        h4 {
            color: #f57c00;
            margin-top: 20px;
            font-size: 16px;
        }
        
        .phase {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .phase h3 {
            color: #1976d2;
            margin-top: 0;
        }
        
        .step {
            background-color: #ffffff;
            border-left: 4px solid #1976d2;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .component-box {
            background-color: #e3f2fd;
            border: 1px solid #1976d2;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .flow-diagram {
            background-color: #f5f5f5;
            border: 2px solid #666;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            font-family: 'Courier New', monospace;
        }
        
        .security-layer {
            background-color: #fff3e0;
            border: 1px solid #f57c00;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .use-case {
            background-color: #e8f5e8;
            border: 1px solid #388e3c;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        
        ul, ol {
            padding-left: 25px;
        }
        
        li {
            margin: 8px 0;
        }
        
        .highlight {
            background-color: #fff59d;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .icon {
            font-size: 18px;
            margin-right: 8px;
        }
        
        .page-break {
            page-break-before: always;
        }
        
        @media print {
            body {
                margin: 20px;
            }
            .page-break {
                page-break-before: always;
            }
        }
    </style>
</head>
<body>

<h1><span class="icon">ğŸ—ï¸</span>Arquitectura del Sistema - Angular + Spring Boot + Azure AD</h1>

<h2>ğŸ“‹ ExplicaciÃ³n Detallada del Flujo de Arquitectura del Sistema</h2>

<div class="phase">
    <h3><span class="icon">ğŸ”</span>Fase 1: InicializaciÃ³n y AutenticaciÃ³n</h3>
    
    <div class="step">
        <h4>1. Usuario accede a la aplicaciÃ³n Angular</h4>
        <ul>
            <li>El usuario abre el navegador y navega a la aplicaciÃ³n</li>
            <li>El <span class="highlight">AppComponent</span> detecta que no hay sesiÃ³n activa</li>
            <li>Se inicializa el sistema de autenticaciÃ³n MSAL (Microsoft Authentication Library)</li>
        </ul>
    </div>
    
    <div class="step">
        <h4>2. RedirecciÃ³n a Azure AD</h4>
        <ul>
            <li>El sistema redirige automÃ¡ticamente al usuario a Microsoft Entra ID (Azure AD)</li>
            <li>El usuario ingresa sus credenciales corporativas</li>
            <li>Azure AD valida la identidad del usuario</li>
        </ul>
    </div>
    
    <div class="step">
        <h4>3. Azure AD procesa la autenticaciÃ³n</h4>
        <ul>
            <li>Azure AD valida las credenciales del usuario</li>
            <li>Consulta los grupos de seguridad a los que pertenece el usuario</li>
            <li>Genera un <span class="highlight">JWT (JSON Web Token)</span> que incluye:
                <ul>
                    <li>InformaciÃ³n del usuario (nombre, email, ID)</li>
                    <li>Lista de grupos de seguridad de Azure AD</li>
                    <li>InformaciÃ³n de expiraciÃ³n y firma digital</li>
                </ul>
            </li>
        </ul>
    </div>
</div>

<div class="phase">
    <h3><span class="icon">ğŸ”„</span>Fase 2: Procesamiento del Token</h3>
    
    <div class="step">
        <h4>4. Angular recibe el token</h4>
        <ul>
            <li>El <span class="highlight">MSAL Interceptor</span> captura automÃ¡ticamente el token</li>
            <li>Almacena el token de forma segura en el navegador (localStorage/sessionStorage)</li>
            <li>El <span class="highlight">AuthorizationService</span> se inicializa con la informaciÃ³n del usuario</li>
        </ul>
    </div>
    
    <div class="step">
        <h4>5. Solicitud de permisos al backend</h4>
        <ul>
            <li>Angular envÃ­a una peticiÃ³n HTTP al endpoint <span class="highlight">/api/auth/permissions</span></li>
            <li>El MSAL Interceptor agrega automÃ¡ticamente el token JWT en el header <span class="highlight">Authorization</span></li>
            <li>Se incluye el formato: <code>Bearer [token_jwt]</code></li>
        </ul>
    </div>
</div>

<div class="phase">
    <h3><span class="icon">ğŸš€</span>Fase 3: ValidaciÃ³n en el Backend</h3>
    
    <div class="step">
        <h4>6. Spring Boot recibe y valida el token</h4>
        <ul>
            <li>El <span class="highlight">AuthController</span> recibe la peticiÃ³n con el token JWT</li>
            <li><span class="highlight">SecurityConfig</span> valida la firma y expiraciÃ³n del token</li>
            <li><span class="highlight">AzureAdGroupsJwtConverter</span> extrae los grupos de Azure AD del token</li>
            <li>Se verifica que el token no haya sido modificado (integridad)</li>
        </ul>
    </div>
    
    <div class="step">
        <h4>7. Mapeo de grupos a perfiles del sistema</h4>
        <ul>
            <li>El sistema consulta la base de datos para encontrar perfiles que coincidan con los grupos de Azure AD</li>
            <li>Ejemplos de mapeo:
                <ul>
                    <li>Grupo "Administradores" â†’ Perfil "admin" del sistema</li>
                    <li>Grupo "Usuarios" â†’ Perfil "user" del sistema</li>
                    <li>Grupo "Gestores" â†’ Perfil "manager" del sistema</li>
                </ul>
            </li>
        </ul>
    </div>
</div>

<div class="phase">
    <h3><span class="icon">ğŸ’¾</span>Fase 4: Consulta de Permisos</h3>
    
    <div class="step">
        <h4>8. Base de datos procesa la consulta</h4>
        <ul>
            <li>Se consulta la tabla <span class="highlight">perfiles</span> para obtener el perfil del usuario</li>
            <li>Se consulta la tabla <span class="highlight">perfil_permisos</span> para obtener los permisos asociados</li>
            <li>Se consulta la tabla <span class="highlight">permisos</span> para obtener los detalles de cada permiso</li>
            <li>Se ejecuta una consulta SQL optimizada que une las tres tablas</li>
        </ul>
    </div>
    
    <div class="step">
        <h4>9. Retorno de informaciÃ³n de permisos</h4>
        <ul>
            <li>La base de datos retorna una lista estructurada de permisos</li>
            <li>El backend formatea esta informaciÃ³n en un JSON claro</li>
            <li>Se incluyen metadatos como fecha de consulta y versiÃ³n de permisos</li>
        </ul>
    </div>
</div>

<div class="phase">
    <h3><span class="icon">ğŸŒ</span>Fase 5: ActualizaciÃ³n de la Interfaz</h3>
    
    <div class="step">
        <h4>10. Angular procesa la respuesta</h4>
        <ul>
            <li>El <span class="highlight">AuthorizationService</span> recibe los permisos del usuario</li>
            <li>Actualiza el estado interno de permisos</li>
            <li>Notifica a todos los componentes suscritos mediante observables</li>
            <li>Se almacena en cachÃ© para optimizar rendimiento</li>
        </ul>
    </div>
    
    <div class="step">
        <h4>11. Componentes actualizan la UI</h4>
        <ul>
            <li><span class="highlight">UserPermissionsComponent</span> muestra el dashboard de permisos</li>
            <li><span class="highlight">ProtectedDataComponent</span> habilita/deshabilita funcionalidades segÃºn permisos</li>
            <li>Los <span class="highlight">Guards</span> permiten o bloquean el acceso a rutas</li>
            <li>Las <span class="highlight">Directives</span> muestran/ocultan elementos en la interfaz</li>
        </ul>
    </div>
</div>

<div class="page-break"></div>

<h2>ğŸ”„ Interacciones Entre Componentes</h2>

<div class="flow-diagram">
    <h3>Flujo de Datos en Tiempo Real</h3>
    <p><strong>Usuario â†’ Azure AD â†’ JWT Token â†’ Angular â†’ Spring Boot â†’ Base de Datos â†’ Permisos â†’ UI</strong></p>
</div>

<h3>Componentes Clave y sus Responsabilidades</h3>

<div class="component-box">
    <h4><span class="icon">ğŸ“¨</span>MSAL Interceptor</h4>
    <p>El "mensajero automÃ¡tico" que agrega tokens a todas las peticiones HTTP de forma transparente para el desarrollador.</p>
</div>

<div class="component-box">
    <h4><span class="icon">ğŸ¯</span>AuthorizationService</h4>
    <p>El "coordinador central" que gestiona todos los permisos, mantiene el estado de autorizaciÃ³n y notifica cambios a los componentes.</p>
</div>

<div class="component-box">
    <h4><span class="icon">ğŸ”„</span>AzureAdGroupsJwtConverter</h4>
    <p>El "traductor" que convierte grupos de Azure AD a roles del sistema interno, permitiendo la integraciÃ³n entre ambos sistemas.</p>
</div>

<div class="component-box">
    <h4><span class="icon">ğŸ›¡ï¸</span>Guards & Directives</h4>
    <p>Los "guardianes" que protegen rutas y elementos de la UI, asegurando que solo usuarios autorizados accedan a funcionalidades especÃ­ficas.</p>
</div>

<h2>ğŸ¯ Casos de Uso TÃ­picos</h2>

<div class="use-case">
    <h3><span class="icon">ğŸ‘‘</span>Escenario 1: Usuario Administrador</h3>
    <ol>
        <li>Se autentica con credenciales de administrador</li>
        <li>Tiene grupo "Administradores" en Azure AD</li>
        <li>Obtiene perfil "admin" en el sistema</li>
        <li>Ve todas las funcionalidades disponibles</li>
        <li>Puede acceder a todas las rutas protegidas</li>
    </ol>
</div>

<div class="use-case">
    <h3><span class="icon">ğŸ‘¤</span>Escenario 2: Usuario Regular</h3>
    <ol>
        <li>Se autentica con credenciales de usuario</li>
        <li>Tiene grupo "Usuarios" en Azure AD</li>
        <li>Obtiene perfil "user" en el sistema</li>
        <li>Ve funcionalidades limitadas segÃºn sus permisos</li>
        <li>No puede acceder a rutas de administraciÃ³n</li>
    </ol>
</div>

<div class="use-case">
    <h3><span class="icon">ğŸš«</span>Escenario 3: Usuario sin Permisos</h3>
    <ol>
        <li>Se autentica correctamente en Azure AD</li>
        <li>No tiene grupos vÃ¡lidos en Azure AD</li>
        <li>No obtiene permisos en el sistema</li>
        <li>Ve pÃ¡gina de acceso denegado</li>
        <li>No puede acceder a ninguna funcionalidad protegida</li>
    </ol>
</div>

<div class="page-break"></div>

<h2>ğŸ”’ Seguridad en Cada Capa</h2>

<div class="security-layer">
    <h3><span class="icon">ğŸŒ</span>Frontend (Angular)</h3>
    <ul>
        <li>Tokens almacenados de forma segura (no en variables globales)</li>
        <li>ValidaciÃ³n de permisos antes de mostrar elementos de UI</li>
        <li>Interceptores HTTP que agregan automÃ¡ticamente tokens</li>
        <li>Guards que protegen rutas sensibles</li>
        <li>Directivas que controlan la visibilidad de elementos</li>
    </ul>
</div>

<div class="security-layer">
    <h3><span class="icon">â˜ï¸</span>Azure AD (Microsoft Entra ID)</h3>
    <ul>
        <li>AutenticaciÃ³n robusta con mÃºltiples factores</li>
        <li>GestiÃ³n centralizada de identidades</li>
        <li>Tokens JWT firmados digitalmente</li>
        <li>Control de acceso basado en grupos</li>
        <li>AuditorÃ­a completa de accesos</li>
    </ul>
</div>

<div class="security-layer">
    <h3><span class="icon">ğŸš€</span>Backend (Spring Boot)</h3>
    <ul>
        <li>ValidaciÃ³n estricta de tokens JWT</li>
        <li>AutorizaciÃ³n granular por endpoint</li>
        <li>ConfiguraciÃ³n de seguridad centralizada</li>
        <li>ConversiÃ³n segura de grupos a roles</li>
        <li>Logging de todas las operaciones sensibles</li>
    </ul>
</div>

<div class="security-layer">
    <h3><span class="icon">ğŸ’¾</span>Base de Datos (H2)</h3>
    <ul>
        <li>Estructura relacional que garantiza integridad de permisos</li>
        <li>Relaciones many-to-many entre perfiles y permisos</li>
        <li>Consultas optimizadas para validaciÃ³n de permisos</li>
        <li>Transacciones ACID para mantener consistencia</li>
        <li>Ãndices en campos crÃ­ticos para rendimiento</li>
    </ul>
</div>

<h2>ğŸ“Š Diagrama de Flujo de Arquitectura</h2>

<div class="flow-diagram">
    <h3>Arquitectura del Sistema</h3>
    <pre>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ğŸŒ Frontend   â”‚    â”‚   â˜ï¸ Microsoft    â”‚    â”‚  ğŸš€ Backend     â”‚
â”‚    Angular      â”‚    â”‚    Entra ID      â”‚    â”‚  Spring Boot    â”‚
â”‚                 â”‚    â”‚                  â”‚    â”‚                 â”‚
â”‚ â€¢ AppComponent  â”‚â—„â”€â”€â–ºâ”‚ â€¢ Azure AD       â”‚â—„â”€â”€â–ºâ”‚ â€¢ AuthControllerâ”‚
â”‚ â€¢ Authorization â”‚    â”‚ â€¢ Grupos Seg.    â”‚    â”‚ â€¢ Authorization â”‚
â”‚   Service       â”‚    â”‚ â€¢ JWT Tokens     â”‚    â”‚   Controller    â”‚
â”‚ â€¢ MSAL Interc.  â”‚    â”‚                  â”‚    â”‚ â€¢ SecurityConfigâ”‚
â”‚ â€¢ Guards        â”‚    â”‚                  â”‚    â”‚ â€¢ JWT Converter â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                               â”‚
         â”‚                                               â–¼
         â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                    â”‚  ğŸ’¾ Base Datos  â”‚
         â”‚                                    â”‚      H2         â”‚
         â”‚                                    â”‚                 â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ â€¢ usuarios      â”‚
                                              â”‚ â€¢ perfiles      â”‚
                                              â”‚ â€¢ permisos      â”‚
                                              â”‚ â€¢ perfil_permisosâ”‚
                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    </pre>
</div>

<h2>âœ… Beneficios de esta Arquitectura</h2>

<ul>
    <li><strong>Seguridad Robusta:</strong> MÃºltiples capas de validaciÃ³n y autorizaciÃ³n</li>
    <li><strong>Escalabilidad:</strong> SeparaciÃ³n clara de responsabilidades entre capas</li>
    <li><strong>Mantenibilidad:</strong> CÃ³digo organizado y componentes reutilizables</li>
    <li><strong>IntegraciÃ³n:</strong> Seamless integration con ecosistema Microsoft</li>
    <li><strong>AuditorÃ­a:</strong> Trazabilidad completa de accesos y permisos</li>
    <li><strong>Flexibilidad:</strong> FÃ¡cil adiciÃ³n de nuevos permisos y roles</li>
</ul>

<h2>ğŸ”§ Consideraciones TÃ©cnicas</h2>

<h3>Rendimiento</h3>
<ul>
    <li>CachÃ© de permisos en el frontend para evitar consultas repetidas</li>
    <li>Tokens JWT con tiempo de vida optimizado</li>
    <li>Consultas SQL optimizadas con Ã­ndices apropiados</li>
</ul>

<h3>Disponibilidad</h3>
<ul>
    <li>Fallback a permisos bÃ¡sicos en caso de error de conexiÃ³n</li>
    <li>Manejo graceful de errores de autenticaciÃ³n</li>
    <li>Retry automÃ¡tico en fallos de red</li>
</ul>

<h3>Monitoreo</h3>
<ul>
    <li>Logging detallado de operaciones de autenticaciÃ³n</li>
    <li>MÃ©tricas de rendimiento de validaciÃ³n de tokens</li>
    <li>Alertas por intentos de acceso no autorizado</li>
</ul>

<div class="page-break"></div>

<h2>ğŸ“ Conclusiones</h2>

<p>Esta arquitectura proporciona una soluciÃ³n robusta y escalable para la gestiÃ³n de autenticaciÃ³n y autorizaciÃ³n en aplicaciones empresariales. La integraciÃ³n con Microsoft Entra ID permite aprovechar la infraestructura de identidades existente, mientras que la separaciÃ³n en capas garantiza la mantenibilidad y seguridad del sistema.</p>

<p>El flujo descrito asegura que cada usuario vea solo las funcionalidades que tiene permitidas, manteniendo la seguridad en todas las capas y proporcionando una experiencia de usuario fluida y segura.</p>

<hr>
<p><em>Documento generado automÃ¡ticamente - Sistema de AutenticaciÃ³n Angular + Spring Boot + Azure AD</em></p>
<p><em>Fecha: ${new Date().toLocaleDateString('es-ES')}</em></p>

</body>
</html>
